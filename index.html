<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zapisy na ciasto</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --cream: #F7F4EF;
            --warm-brown: #8B7355;
            --deep-brown: #5C4A3D;
            --gold: #C9A962;
            --soft-gold: #E8D5A3;
            --white: #FFFFFF;
            --shadow: rgba(92, 74, 61, 0.08);
        }
        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--cream);
            min-height: 100vh;
            color: var(--deep-brown);
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 80%, var(--soft-gold) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, var(--soft-gold) 0%, transparent 40%);
            opacity: 0.3;
            pointer-events: none;
            z-index: -1;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 40px 20px; }
        .header { text-align: center; margin-bottom: 50px; }
        .header-icon { font-size: 48px; margin-bottom: 16px; display: block; }
        h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2.8rem;
            font-weight: 500;
            color: var(--deep-brown);
            margin-bottom: 8px;
        }
        .subtitle { color: var(--warm-brown); font-size: 1.1rem; }
        .sunday-card {
            background: var(--white);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 20px;
            box-shadow: 0 4px 24px var(--shadow);
            border: 1px solid rgba(201, 169, 98, 0.15);
        }
        .sunday-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--soft-gold);
            flex-wrap: wrap;
            gap: 10px;
        }
        .sunday-date {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
            font-weight: 600;
        }
        .signup-count {
            background: linear-gradient(135deg, var(--gold) 0%, var(--soft-gold) 100%);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .signups-list { margin-bottom: 20px; }
        .signup-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed rgba(139, 115, 85, 0.2);
            flex-wrap: wrap;
            gap: 8px;
        }
        .signup-item:last-child { border-bottom: none; }
        .signup-name { font-weight: 500; min-width: 120px; }
        .signup-cake { color: var(--warm-brown); flex: 1; }
        .signup-delete {
            background: none;
            border: none;
            color: #c97a7a;
            cursor: pointer;
            padding: 4px 8px;
            opacity: 0.6;
        }
        .signup-delete:hover { opacity: 1; }
        .signup-form { display: flex; gap: 12px; flex-wrap: wrap; }
        .input-group { flex: 1; min-width: 140px; }
        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--soft-gold);
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.95rem;
            background: var(--cream);
        }
        .input-group input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(201, 169, 98, 0.2);
        }
        .btn {
            background: linear-gradient(135deg, var(--deep-brown) 0%, var(--warm-brown) 100%);
            color: var(--white);
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(92, 74, 61, 0.3); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .empty-state { text-align: center; padding: 20px; color: var(--warm-brown); font-style: italic; }
        .footer { text-align: center; margin-top: 50px; padding-top: 30px; border-top: 1px solid var(--soft-gold); color: var(--warm-brown); }

        /* Login */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .login-box {
            background: var(--white);
            border-radius: 20px;
            padding: 48px 40px;
            box-shadow: 0 8px 40px var(--shadow);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        .login-box h1 { font-size: 2rem; margin-bottom: 8px; }
        .login-box .subtitle { margin-bottom: 32px; }
        .login-form { display: flex; flex-direction: column; gap: 16px; }
        .login-form input {
            padding: 14px 18px;
            border: 2px solid var(--soft-gold);
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            text-align: center;
            background: var(--cream);
        }
        .login-form input:focus {
            outline: none;
            border-color: var(--gold);
        }
        .login-error { color: #c97a7a; margin-top: 12px; }
        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--white);
            border: 1px solid var(--soft-gold);
            padding: 8px 16px;
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            z-index: 100;
        }
        .hidden { display: none !important; }

        @media (max-width: 600px) {
            h1 { font-size: 2rem; }
            .signup-form { flex-direction: column; }
            .input-group { min-width: 100%; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <div class="login-box">
            <span class="header-icon">üîê</span>
            <h1>Zapisy na ciasto</h1>
            <p class="subtitle">Podaj has≈Ço, aby kontynuowaƒá</p>
            <form class="login-form" id="login-form">
                <input type="password" id="password-input" placeholder="Has≈Ço" required>
                <button type="submit" class="btn">Wejd≈∫</button>
            </form>
            <p id="login-error" class="login-error hidden">Nieprawid≈Çowe has≈Ço</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="container hidden">
        <button class="logout-btn" id="logout-btn">Wyloguj</button>
        <header class="header">
            <span class="header-icon">üç∞</span>
            <h1>Zapisy na ciasto</h1>
            <p class="subtitle">Wybierz niedzielƒô i zapisz siƒô z ciastem!</p>
        </header>
        <div id="sundays-list"></div>
        <footer class="footer">
            <p>Zrobione z ‚ù§Ô∏è dla wsp√≥lnoty</p>
        </footer>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        // ============================================
        // KONFIGURACJA
        // ============================================
        const SUPABASE_URL = 'https://tkxfzyjtopxphqnevcuj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRreGZ6eWp0b3B4cGhxbmV2Y3VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMDcyNzYsImV4cCI6MjA4NDY4MzI3Nn0.F1btQFkcE_6QLc5YjnNTh2yKJ7lq_UD7HfHO6uj0RxM';
        // ============================================

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const app = document.getElementById('app');
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('password-input');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const sundaysList = document.getElementById('sundays-list');

        // Hash password
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Verify password
        async function verifyPassword(password) {
            const hash = await hashPassword(password);
            const { data, error } = await supabase
                .from('app_settings')
                .select('value')
                .eq('key', 'admin_password_hash')
                .single();
            
            if (error || !data) return false;
            return data.value === hash;
        }

        // Get upcoming Sundays
        function getUpcomingSundays(count = 8) {
            const sundays = [];
            const today = new Date();
            let current = new Date(today);
            const dayOfWeek = current.getDay();
            const daysUntilSunday = dayOfWeek === 0 ? 0 : 7 - dayOfWeek;
            current.setDate(current.getDate() + daysUntilSunday);
            
            for (let i = 0; i < count; i++) {
                sundays.push(new Date(current));
                current.setDate(current.getDate() + 7);
            }
            return sundays;
        }

        // Format date
        function formatDate(date) {
            return date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function formatDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        // Render sundays
        async function renderSundays() {
            const sundays = getUpcomingSundays(8);
            const { data: signups } = await supabase
                .from('cake_signups')
                .select('*')
                .order('created_at', { ascending: true });

            sundaysList.innerHTML = sundays.map(sunday => {
                const dateKey = formatDateKey(sunday);
                const daySignups = (signups || []).filter(s => s.sunday_date === dateKey);
                const countText = daySignups.length === 1 ? 'osoba' : daySignups.length < 5 ? 'osoby' : 'os√≥b';

                return `
                    <div class="sunday-card">
                        <div class="sunday-header">
                            <div class="sunday-date">‚òÄÔ∏è Niedziela, ${formatDate(sunday)}</div>
                            <div class="signup-count">${daySignups.length} ${countText}</div>
                        </div>
                        ${daySignups.length > 0 ? `
                            <div class="signups-list">
                                ${daySignups.map(s => `
                                    <div class="signup-item">
                                        <span class="signup-name">üç∞ ${s.name}</span>
                                        <span class="signup-cake">${s.cake_description}</span>
                                        <button class="signup-delete" data-id="${s.id}">‚úï</button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `<div class="empty-state">Brak zapis√≥w ‚Äî bƒÖd≈∫ pierwszy! üéÇ</div>`}
                        <form class="signup-form" data-date="${dateKey}">
                            <div class="input-group">
                                <input type="text" name="name" placeholder="Twoje imiƒô" maxlength="50" required>
                            </div>
                            <div class="input-group">
                                <input type="text" name="cake" placeholder="Co przyniesiesz?" maxlength="100" required>
                            </div>
                            <button type="submit" class="btn">Zapisz siƒô</button>
                        </form>
                    </div>
                `;
            }).join('');

            // Add event listeners
            document.querySelectorAll('.signup-form').forEach(form => {
                form.addEventListener('submit', handleSignup);
            });
            document.querySelectorAll('.signup-delete').forEach(btn => {
                btn.addEventListener('click', handleDelete);
            });
        }

        // Handle signup
        async function handleSignup(e) {
            e.preventDefault();
            const form = e.target;
            const dateKey = form.dataset.date;
            const name = form.name.value.trim();
            const cake = form.cake.value.trim();

            if (!name || !cake) return;

            await supabase.from('cake_signups').insert([{
                sunday_date: dateKey,
                name: name,
                cake_description: cake
            }]);

            form.reset();
            renderSundays();
        }

        // Handle delete
        async function handleDelete(e) {
            if (!confirm('UsunƒÖƒá wpis?')) return;
            const id = e.target.dataset.id;
            await supabase.from('cake_signups').delete().eq('id', id);
            renderSundays();
        }

        // Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.classList.add('hidden');
            
            const isValid = await verifyPassword(passwordInput.value);
            
            if (isValid) {
                localStorage.setItem('cake_auth', 'true');
                showApp();
            } else {
                loginError.classList.remove('hidden');
                passwordInput.value = '';
            }
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('cake_auth');
            loginScreen.classList.remove('hidden');
            app.classList.add('hidden');
        });

        // Show app
        function showApp() {
            loginScreen.classList.add('hidden');
            app.classList.remove('hidden');
            renderSundays();
        }

        // Init
        if (localStorage.getItem('cake_auth') === 'true') {
            showApp();
        }

        // Realtime
        supabase.channel('changes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'cake_signups' }, () => {
                renderSundays();
            })
            .subscribe();
    </script>
</body>
</html>
